# Story 01.04: Setup Docker Compose Development Environment

**Epic:** Epic 1 - Foundation Setup
**Story ID:** STORY-01-04
**Priority:** P0 (Blocking)
**Estimated:** 5 hours

---

## Status

**Draft**

---

## Story

**As a** developer,
**I want** Docker Compose configured for local development with PostgreSQL, RabbitMQ, Prometheus, and Grafana,
**so that** I can run the complete infrastructure stack locally with a single command and develop services against real dependencies.

---

## Acceptance Criteria

1. `docker-compose.yml` created in repository root for development
2. PostgreSQL 16 container configured with 6 databases
3. `infrastructure/postgres/init-databases.sql` script creates all databases
4. RabbitMQ 3.12 container configured with management UI
5. Prometheus container configured with basic scrape config
6. Grafana container configured with admin credentials
7. `.env.example` file created with required environment variables
8. `docker-compose up -d` starts all services successfully
9. PostgreSQL accessible at localhost:5432
10. RabbitMQ management UI accessible at localhost:15672
11. Prometheus UI accessible at localhost:9090
12. Grafana UI accessible at localhost:3000
13. Health checks configured for all services
14. Volumes configured for data persistence

---

## Tasks / Subtasks

- [ ] Create PostgreSQL initialization script (AC: 2, 3)
  - [ ] Create `infrastructure/postgres/init-databases.sql`
  - [ ] Add CREATE DATABASE statements for all 6 databases (user_db, transaction_db, ai_db, budget_db, notification_db, api_gateway_db)
  - [ ] Add database owner/permissions configuration
  - [ ] Include comments explaining each database purpose

- [ ] Create docker-compose.yml file (AC: 1, 8)
  - [ ] Create `docker-compose.yml` at repository root
  - [ ] Add version: '3.8' at top
  - [ ] Define networks section (budgetcoach-network)
  - [ ] Define volumes section for persistence

- [ ] Configure PostgreSQL service (AC: 2, 3, 9, 13, 14)
  - [ ] Add postgres service using postgres:16-alpine image
  - [ ] Configure environment variables (POSTGRES_USER, POSTGRES_PASSWORD)
  - [ ] Mount init-databases.sql to /docker-entrypoint-initdb.d/
  - [ ] Expose port 5432:5432
  - [ ] Add health check with pg_isready
  - [ ] Create postgres-data volume for persistence
  - [ ] Connect to budgetcoach-network

- [ ] Configure RabbitMQ service (AC: 4, 10, 13, 14)
  - [ ] Add rabbitmq service using rabbitmq:3.12-management-alpine image
  - [ ] Configure environment variables (RABBITMQ_DEFAULT_USER, RABBITMQ_DEFAULT_PASS)
  - [ ] Expose ports 5672:5672 (AMQP) and 15672:15672 (Management UI)
  - [ ] Add health check with rabbitmq-diagnostics
  - [ ] Create rabbitmq-data volume for persistence
  - [ ] Connect to budgetcoach-network

- [ ] Configure Prometheus service (AC: 5, 11, 13, 14)
  - [ ] Create `infrastructure/prometheus/prometheus.yml` config file
  - [ ] Add prometheus service using prom/prometheus:latest image
  - [ ] Mount prometheus.yml configuration
  - [ ] Expose port 9090:9090
  - [ ] Add basic scrape configs (placeholder for future services)
  - [ ] Create prometheus-data volume for persistence
  - [ ] Connect to budgetcoach-network

- [ ] Configure Grafana service (AC: 6, 12, 13, 14)
  - [ ] Add grafana service using grafana/grafana:latest image
  - [ ] Configure environment variables (GF_SECURITY_ADMIN_USER, GF_SECURITY_ADMIN_PASSWORD)
  - [ ] Expose port 3000:3000
  - [ ] Create grafana-data volume for persistence
  - [ ] Connect to budgetcoach-network
  - [ ] Add health check

- [ ] Create .env.example file (AC: 7)
  - [ ] Create `.env.example` at repository root
  - [ ] Add all required environment variables with example values
  - [ ] Add comments explaining each variable
  - [ ] Include instructions to copy to .env for local use
  - [ ] Document default credentials (for development only)

- [ ] Create Prometheus configuration (AC: 5)
  - [ ] Create `infrastructure/prometheus/prometheus.yml`
  - [ ] Add global scrape configuration (15s interval)
  - [ ] Add scrape config for Prometheus self-monitoring
  - [ ] Add placeholder scrape configs for future services (commented out)
  - [ ] Include comments explaining configuration

- [ ] Create infrastructure README (AC: 8)
  - [ ] Create `infrastructure/README.md`
  - [ ] Document how to start/stop services
  - [ ] List all service URLs and default credentials
  - [ ] Add troubleshooting section
  - [ ] Include prerequisites (Docker, Docker Compose installed)

- [ ] Test Docker Compose stack (AC: 8, 9, 10, 11, 12, 13)
  - [ ] Run `docker-compose up -d`
  - [ ] Verify all containers start successfully
  - [ ] Run `docker-compose ps` - all services should show "Up" and "healthy"
  - [ ] Test PostgreSQL connection: `psql -h localhost -U budgetcoach -c "\l"`
  - [ ] Verify 6 databases created
  - [ ] Access RabbitMQ UI at http://localhost:15672
  - [ ] Access Prometheus UI at http://localhost:9090
  - [ ] Access Grafana UI at http://localhost:3000
  - [ ] Verify data persists after `docker-compose down` and `docker-compose up -d`

---

## Dev Notes

### Architecture Reference

- **Primary Source:** `docs/deployment-plan.md` Appendix A (Docker Compose Configuration)
- **Tech Stack:** `docs/architecture/tech-stack.md` Section 4 (Data & Messaging Layer)

### Database Names

The 6 PostgreSQL databases to create:
1. **user_db** - User service (users, refresh tokens)
2. **transaction_db** - Transaction service (transactions, CSV templates)
3. **ai_db** - AI service (insights, categorization cache)
4. **budget_db** - Budget service (budgets, budget alerts)
5. **notification_db** - Notification service (notifications, preferences, email logs)
6. **api_gateway_db** - API Gateway (rate limiting, request logs) - *Optional for MVP*

### PostgreSQL Init Script Template

```sql
-- Create all databases for AI Budgeting Coach microservices
-- This script runs automatically when PostgreSQL container initializes

-- User Service Database
CREATE DATABASE user_db;
COMMENT ON DATABASE user_db IS 'User management and authentication';

-- Transaction Service Database
CREATE DATABASE transaction_db;
COMMENT ON DATABASE transaction_db IS 'Transaction CRUD and CSV imports';

-- AI Service Database
CREATE DATABASE ai_db;
COMMENT ON DATABASE ai_db IS 'AI categorization and insights';

-- Budget Service Database
CREATE DATABASE budget_db;
COMMENT ON DATABASE budget_db IS 'Budget tracking and alerts';

-- Notification Service Database
CREATE DATABASE notification_db;
COMMENT ON DATABASE notification_db IS 'Notifications and email delivery';

-- API Gateway Database (optional for MVP)
CREATE DATABASE api_gateway_db;
COMMENT ON DATABASE api_gateway_db IS 'API Gateway rate limiting and logs';

-- Grant all privileges to budgetcoach user
GRANT ALL PRIVILEGES ON DATABASE user_db TO budgetcoach;
GRANT ALL PRIVILEGES ON DATABASE transaction_db TO budgetcoach;
GRANT ALL PRIVILEGES ON DATABASE ai_db TO budgetcoach;
GRANT ALL PRIVILEGES ON DATABASE budget_db TO budgetcoach;
GRANT ALL PRIVILEGES ON DATABASE notification_db TO budgetcoach;
GRANT ALL PRIVILEGES ON DATABASE api_gateway_db TO budgetcoach;
```

### Docker Compose Service Configuration

**PostgreSQL Service:**
```yaml
postgres:
  image: postgres:16-alpine
  container_name: budgetcoach-postgres
  environment:
    POSTGRES_USER: ${POSTGRES_USER:-budgetcoach}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-budgetcoach}
    POSTGRES_DB: postgres
  ports:
    - "5432:5432"
  volumes:
    - postgres-data:/var/lib/postgresql/data
    - ./infrastructure/postgres/init-databases.sql:/docker-entrypoint-initdb.d/init.sql
  networks:
    - budgetcoach-network
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U budgetcoach"]
    interval: 10s
    timeout: 5s
    retries: 5
```

**RabbitMQ Service:**
```yaml
rabbitmq:
  image: rabbitmq:3.12-management-alpine
  container_name: budgetcoach-rabbitmq
  environment:
    RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
    RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-guest}
  ports:
    - "5672:5672"   # AMQP port
    - "15672:15672" # Management UI
  volumes:
    - rabbitmq-data:/var/lib/rabbitmq
  networks:
    - budgetcoach-network
  healthcheck:
    test: ["CMD", "rabbitmq-diagnostics", "ping"]
    interval: 10s
    timeout: 5s
    retries: 5
```

**Prometheus Service:**
```yaml
prometheus:
  image: prom/prometheus:latest
  container_name: budgetcoach-prometheus
  command:
    - '--config.file=/etc/prometheus/prometheus.yml'
    - '--storage.tsdb.path=/prometheus'
  ports:
    - "9090:9090"
  volumes:
    - ./infrastructure/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    - prometheus-data:/prometheus
  networks:
    - budgetcoach-network
```

**Grafana Service:**
```yaml
grafana:
  image: grafana/grafana:latest
  container_name: budgetcoach-grafana
  environment:
    GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
    GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
  ports:
    - "3000:3000"
  volumes:
    - grafana-data:/var/lib/grafana
  networks:
    - budgetcoach-network
  depends_on:
    - prometheus
```

### .env.example Template

```bash
# AI Budgeting Coach - Development Environment Variables
# Copy this file to .env and update values as needed

# PostgreSQL Configuration
POSTGRES_USER=budgetcoach
POSTGRES_PASSWORD=budgetcoach_dev_password

# RabbitMQ Configuration
RABBITMQ_USER=guest
RABBITMQ_PASSWORD=guest

# Grafana Configuration
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=admin

# Note: These are development defaults. NEVER use these in production!
```

### Prometheus Configuration Template

```yaml
# Prometheus Configuration for AI Budgeting Coach
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Future: Microservices endpoints (add when services expose /metrics)
  # - job_name: 'user-service'
  #   static_configs:
  #     - targets: ['user-service:8080']
  #
  # - job_name: 'transaction-service'
  #   static_configs:
  #     - targets: ['transaction-service:8080']
```

### Networks and Volumes

```yaml
networks:
  budgetcoach-network:
    driver: bridge

volumes:
  postgres-data:
  rabbitmq-data:
  prometheus-data:
  grafana-data:
```

### Service Access URLs (Development)

| Service | URL | Default Credentials |
|---------|-----|---------------------|
| PostgreSQL | localhost:5432 | budgetcoach / budgetcoach |
| RabbitMQ AMQP | localhost:5672 | guest / guest |
| RabbitMQ Management UI | http://localhost:15672 | guest / guest |
| Prometheus | http://localhost:9090 | (no auth) |
| Grafana | http://localhost:3000 | admin / admin |

### Testing

#### Testing Standards

**Test Location:** Manual verification - no automated tests for infrastructure setup

**Build Commands:**
```bash
# Start all services
docker-compose up -d

# Check service status
docker-compose ps

# View logs
docker-compose logs -f

# Stop all services
docker-compose down

# Stop and remove volumes (fresh start)
docker-compose down -v
```

**PostgreSQL Verification:**
```bash
# Test connection and list databases
psql -h localhost -p 5432 -U budgetcoach -c "\l"

# Expected output: 6 databases listed (user_db, transaction_db, etc.)

# Connect to specific database
psql -h localhost -p 5432 -U budgetcoach -d user_db
```

**RabbitMQ Verification:**
- Open browser: http://localhost:15672
- Login with guest/guest
- Verify management UI loads
- Check "Overview" tab shows healthy status

**Prometheus Verification:**
- Open browser: http://localhost:9090
- Check "Status" > "Targets" - should show prometheus target as UP
- Run test query: `up` should return 1

**Grafana Verification:**
- Open browser: http://localhost:3000
- Login with admin/admin
- Verify dashboard loads

**Health Check Verification:**
```bash
# All services should show "healthy" status
docker-compose ps

# Expected output format:
# NAME                    STATUS
# budgetcoach-postgres    Up (healthy)
# budgetcoach-rabbitmq    Up (healthy)
# budgetcoach-prometheus  Up
# budgetcoach-grafana     Up
```

**Data Persistence Verification:**
```bash
# Create test data in PostgreSQL
psql -h localhost -U budgetcoach -d user_db -c "CREATE TABLE test (id int);"

# Stop containers
docker-compose down

# Start again
docker-compose up -d

# Verify data persists
psql -h localhost -U budgetcoach -d user_db -c "\dt"
# Should show "test" table

# Clean up
psql -h localhost -U budgetcoach -d user_db -c "DROP TABLE test;"
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-06 | 1.0 | Initial story creation from epic | Winston (Architect) |

---

## Dev Agent Record

### Agent Model Used

_[To be filled by dev agent]_

### Debug Log References

_[To be filled by dev agent]_

### Completion Notes List

_[To be filled by dev agent]_

### File List

_[To be filled by dev agent]_

---

## QA Results

_[To be filled by QA agent after implementation]_
